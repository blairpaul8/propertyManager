<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Property Manager</title>
    <link rel="stylesheet" href="main.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <script src="https://unpkg.com/read-excel-file@4.x/bundle/read-excel-file.min.js"></script>
  </head>
  <body>
    <dialog id="editTeamModal" class="editTeamModal">
      <button id="closeModal" class="closeModal">Save Team</button>
    </dialog>
    <dialog id="fromTo" class="fromTo">
      <form id="fromToForm" class="fromToForm">
        <div id="roleCheckBoxes" class="roleCheckBoxes"></div>
        <div>
          <label for="from"> From: </label>
          <input type="text" name="from" id="from" value="" />
          <label for="to"> To: </label>
          <input type="text" name="to" id="to" value="" />
        </div>
        <button type="submit">Generate 2062</button>
      </form>
    </dialog>
    <div id="startPage" class="startPage">
      <div class="addExcelFile">
        <svg
          class="excelIcon"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
          class="size-6"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M3.375 19.5h17.25m-17.25 0a1.125 1.125 0 0 1-1.125-1.125M3.375 19.5h7.5c.621 0 1.125-.504 1.125-1.125m-9.75 0V5.625m0 12.75v-1.5c0-.621.504-1.125 1.125-1.125m18.375 2.625V5.625m0 12.75c0 .621-.504 1.125-1.125 1.125m1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125m0 3.75h-7.5A1.125 1.125 0 0 1 12 18.375m9.75-12.75c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125m19.5 0v1.5c0 .621-.504 1.125-1.125 1.125M2.25 5.625v1.5c0 .621.504 1.125 1.125 1.125m0 0h17.25m-17.25 0h7.5c.621 0 1.125.504 1.125 1.125M3.375 8.25c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125m17.25-3.75h-7.5c-.621 0-1.125.504-1.125 1.125m8.625-1.125c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125m-17.25 0h7.5m-7.5 0c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125M12 10.875v-1.5m0 1.5c0 .621-.504 1.125-1.125 1.125M12 10.875c0 .621.504 1.125 1.125 1.125m-2.25 0c.621 0 1.125.504 1.125 1.125M13.125 12h7.5m-7.5 0c-.621 0-1.125.504-1.125 1.125M20.625 12c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125m-17.25 0h7.5M12 14.625v-1.5m0 1.5c0 .621-.504 1.125-1.125 1.125M12 14.625c0 .621.504 1.125 1.125 1.125m-2.25 0c.621 0 1.125.504 1.125 1.125m0 1.5v-1.5m0 0c0-.621.504-1.125 1.125-1.125m0 0h7.5"
          />
        </svg>
        <div class="fileInput">
          <label for="input" class="btn">Choose excel file</label>
          <input id="input" style="visibility: hidden" type="file" />
        </div>
      </div>
    </div>
    <div class="mainPage" id="mainPage" style="display: none">
      <div class="topBar">
        <div class="teamNumber">SFOD-A 2112</div>
        <div class="searchBar">
          <input
            type="text"
            placeholder="Search Equipment"
            name="search"
            class="search"
          />
          <button>
            <img src="search-icon.svg" class="weatherIcons" />
            <!-- I don't think we even need a search button, we can just filter
                             the list as soon as they type as there are no network requests to slow things down -->
          </button>
        </div>
        <div class="teamMembers">
          <button class="membersDropDown">Team Members</button>
          <div id="teamNames" class="teamNames">
            <div id="namesList"></div>
            <button
              id="editTeam"
              class="editTeamMembers"
              onclick="((event) => {modal.showModal()})();"
            >
              Edit Team
            </button>
          </div>
        </div>
      </div>

      <div class="bodyWrapper">
        <div class="sidebar">
          <div>
            <button
              class="propertyByMOS"
              onclick="((event) => {filterBySection(bravo_property)})()"
            >
              18B Property
            </button><button
            class="propertyByMOS"
            onclick="((event) => {filterBySection(delta_property)})()"
            >
              18C Property
            </button>
            <button
              class="propertyByMOS"
              onclick="((event) => {filterBySection(charlie_property)})()"
            >
              18D Property
            </button>
       
          <button
            class="propertyByMOS"
            onclick="((event) => {filterBySection(echo_property)})()"
          >
            18E Property
          </button>
          </div>
          <button
            class="boxesPageButton"
            onclick="((event) => {toggle_page('boxes_page')})();"
          >
            Boxes View
          </button>
        </div>
        <div id="inventoryList" class="inventoryList"></div>
      </div>
    </div>

    <div id="boxesPage" style="display: none">
      <div class="topBar">
        <div class="teamNumber">SFOD-A 2112</div>
        <div class="searchBar">
          <input
            type="text"
            placeholder="Search Equipment"
            name="search"
            class="search"
          />
          <button>
            <img src="search-icon.svg" class="weatherIcons" />
            <!-- I don't think we even need a search button, we can just filter
                             the list as soon as they type as there are no network requests to slow things down -->
          </button>
        </div>
        <div class="teamMembers">
          <button class="membersDropDown">Team Members</button>
          <div id="teamNames" class="teamNames">
            <button id="editTeam" class="editTeamMembers">Edit Team</button>
          </div>
        </div>
      </div>

      <div id="boxesList" class="boxesList">
        <button
          id="generateMasterButton"
          class="generateMasterButton"
          onclick=""
        >
          Generate Master 2062
        </button>
      </div>
    </div>
  </body>
  <script type="text/javascript">
    /*
     * PAGES
     * Each Page should have its own element in the 'pages' array.
     * Pages are identified by a page_name, the actual element,
     * and an optional function which should be called to render any dynamic content.
     */
    const pages = [
      {
        page_name: "start_page",
        element: document.getElementById("startPage"),
        render_func: null,
      },
      {
        page_name: "main_page",
        element: document.getElementById("mainPage"),
        render_func: render_list,
      },
      {
        page_name: "boxes_page",
        element: document.getElementById("boxesPage"),
        render_func: render_boxes,
      },
    ];

    // Toggles which 'Page' is currently being displayed.
    // Any arguments to be passed to a pages 'render_func' are
    // passed though the args parameter, which accepts 0 or more arguments.
    // Example: toggle_page('main_page', document.getElementById('inventoryList'), items)
    // Example: toggle_page('boxes_page', [{ name: "Tony", role: "Z" }, { name: "Rhyan", role: "E2" }])
    function toggle_page(page_name, ...args) {
      pages.forEach((page) => {
        if (page.page_name === page_name) {
          if (page.render_func !== null) {
            page.render_func(...args);
          }
          page.element.style.display = "block";
        } else {
          page.element.style.display = "none";
        }
      });
    }

    /**
     * Parse `data` into individual items.
     * @param {string{}{}} data - row-by-row view of the property book
     */
    function parseItems(data) {
      var items = [];
      var currentItem = [];
      for (let i = 0; i < data.length; i++) {
        if (data[i][0] === "MPO") {
          if (currentItem.length > 0) {
            items.push(currentItem);
          }
          currentItem = []; // Reset currentItem for the next MPO
          currentItem.push(data[i]);
        } else {
          currentItem.push(data[i]);
        }
      }

      if (currentItem.length > 0) {
        items.push(currentItem);
      }

      return items;
    }

    class nsn_item {
      nsn;
      nsn_description;
      ui;
      ciic;
      dla;
      buom;
      quantity;
      // Mapping of serial numbers to roles [{'serial_number': 431431, 'assignment': 'E1'}, ...]
      serial_numbers = [];

      constructor(nsn_item_row) {
        this.nsn = nsn_item_row[1][0];
        this.nsn_description = nsn_item_row[1][2];
        this.ui = nsn_item_row[1][5];
        this.ciic = nsn_item_row[1][7];
        this.dla = nsn_item_row[1][8];
        this.buom = nsn_item_row[1][9];
        this.quantity = nsn_item_row[1][10];

        for (let i = 3; i < nsn_item_row.length; i++) {
          if (nsn_item_row[i][0] === "SysNo") {
            continue;
          }
          // The three possible spots for a serial number
          // We need to check each for null/undefined so those don't up in the array
          if (nsn_item_row[i][1]) {
            this.serial_numbers.push({
              serial_number: nsn_item_row[i][1],
              assignment: null,
            });
          }
          if (nsn_item_row[i][5]) {
            this.serial_numbers.push({
              serial_number: nsn_item_row[i][5],
              assignment: null,
            });
          }
          if (nsn_item_row[i][10]) {
            this.serial_numbers.push({
              serial_number: nsn_item_row[i][10],
              assignment: null,
            });
          }
        }

        // Prevents new fields from being added in the future, acts more like a struct
        Object.seal(this);
      }
    }

    class item {
      mpo;
      mpo_description;
      nsn_items = [];

      constructor(item_rows) {
        let header = []; // Just MPO and MPO Description
        let nsns = []; // Double nested array, [[nsn & all serial numbers], [nsn & all serial numbers]]

        let cursor = 0;

        for (let i = 0; i < item_rows.length; i++) {
          // We reached the end of the header
          if (item_rows[i][0] === "NSN" && cursor === 0) {
            header = item_rows.slice(0, i);
            cursor = i;
            continue;
          }

          // Item has multiples NSNs
          if (item_rows[i][0] === "NSN") {
            nsns.push(item_rows.slice(cursor, i));
            cursor = i;
            continue;
          }

          // Last serial number block
          if (i === item_rows.length - 1) {
            nsns.push(item_rows.slice(cursor));
          }
        }

        if (header.length > 1) {
          // Some items don't have an mpo description
          this.mpo = header[1][0];
          this.mpo_description = header[1][2];
        }

        // Add a new NSN for each serial number block
        nsns.forEach((nsn_item_rows) => {
          this.nsn_items.push(new nsn_item(nsn_item_rows));
        });

        // Prevents new fields from being added in the future, acts more like a struct
        Object.seal(this);
      }
    }

    //Section Property Arrrays by key word.
    let echo_property = [
      "A35329",
      "C05002",
      "E05011",
      "FA205N",
      "FA20A2",
      "FA950P",
      "M18029",
      "P05003",
      "R30308",
      "R45463",
    ];


    function filterBySection(section) {
      
      const results = [];
      let temp = "";
      
      items.forEach((item) => {
        section.forEach((keyword) => {
          if (!item.mpo_description) {
            return;
          }
          if (item.mpo_description.slice(0,6) === keyword) {
            results.push(item);
          }
        });
      });

      //console.log(results);
      toggle_page(
          "main_page",
          document.getElementById("inventoryList"),
          results
        );
    }

    /**
     * Fuzzy Matching function and filterProperty function used to filter the list of items based
     * on which section property button is selected.
     */
    function fuzzyMatching(a, b) {
      const matrix = [];

      // Initialize the matrix
      for (let i = 0; i <= b.length; i++) {
        matrix[i] = [i];
      }
      for (let j = 0; j <= a.length; j++) {
        matrix[0][j] = j;
      }

      // Calculate the distance
      for (let i = 1; i <= b.length; i++) {
        for (let j = 1; j <= a.length; j++) {
          if (b[i - 1] === a[j - 1]) {
            matrix[i][j] = matrix[i - 1][j - 1];
          } else {
            matrix[i][j] = Math.min(
              matrix[i - 1][j - 1] + 1, // Substitution
              matrix[i][j - 1] + 1, // Insertion
              matrix[i - 1][j] + 1, // Deletion
            );
          }
        }
      }

      const distance = matrix[b.length][a.length];

      const longestLength = Math.max(a.length, b.length);
      return distance / longestLength;
    }

    /**
      * Render `items` as a list, inserted into the dom at `root`
      * Will also clear the previous list
      * @param root - element where the list should be rendered, document.getElementById('inventoryList')
      * @param items {[]item} - A list of items from the class above, this can/should be filtered down for searching \
      * Choose excel file
      */
    function render_list(root, items) {
      root.innerHTML = "";

      items.forEach((item) => {
        const rand_item = Math.floor(Math.random() * 100000);
        const html = `<div class="item">
                  <details class="itemDetails">
                    <summary id="itemHeader${rand_item}" class="itemHeader"><span class="name">${item.mpo_description ? item.mpo_description : "No MPO"}</span></span></span>
                      <svg class="icons" data-slot="icon" aria-hidden="true" fill="none" stroke-width="1.5" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="m19.5 8.25-7.5 7.5-7.5-7.5" stroke-linecap="round" stroke-linejoin="round"></path>
                      </svg>
                    </summary>
                  </details>
                </div>`;
        root.insertAdjacentHTML("beforeend", html);

        item.nsn_items.forEach((nsn_item) => {
          // Header for this NSN item
          const rand_header = Math.floor(Math.random() * 100000);
          const header = `<div id=header${rand_header}>${nsn_item.nsn} ${nsn_item.nsn_description} ${nsn_item.quantity}</div>`;
          document
            .getElementById(`itemHeader${rand_item}`)
            .insertAdjacentHTML("afterend", header);

          // Insert the serial numbers for this NSN item
          nsn_item.serial_numbers.forEach((serial_number) => {
            const rand_serial = Math.floor(Math.random() * 100000);
            const serial_number_element = `<div class="serialNumber">
                                       <div class="serial">${serial_number.serial_number}</div>
                                       <select id="serial${rand_serial}" name="">
                                           <option value="">--</option>
                                       </select>
                                   </div>`;

            const header_element = document.getElementById(
              `header${rand_header}`,
            );
            header_element.insertAdjacentHTML(
              "afterend",
              serial_number_element,
            );

            const select_box = document.getElementById(`serial${rand_serial}`);
            select_box.addEventListener("change", (event) => {
              serial_number.assignment = document.getElementById(
                `serial${rand_serial}`,
              ).value;
            });

            roles.forEach((person) => {
              const option_html = `<option value="${person.role}">${person.role} (${person.name})</option>`;
              document
                .getElementById(`serial${rand_serial}`)
                .insertAdjacentHTML("beforeend", option_html);
            });
          });
        });
      });
    }

    /**
     * Build the 'boxes' view last based on global 'items' list.
     * Any unassigned items will not be populated into the list.
     * This list is a subset of items.
     * @param role_list {String[]} - Roles to include in generated list, if null all roles are included
     * @returns boxes - Mapping of roles to items assigned to those roles
     */
    function build_boxes(role_list) {
      if (!role_list) {
        role_list = roles;
      }

      let role_symbols = role_list.map((a) => a.role);

      // A map of key 'role name' => value 'item' & serial_number(s)
      // [{role: 'E1', [{item: {...}, serial_numbers: [431, 412]}, ...]}, ...]
      const boxes = new Map();

      // Loop through the entire items list, we need to boil down to each serial number
      // and determine who that serial number is assigned to, then filters further to
      // check first that the item is assigned at all, and that the role is in our role_list
      items.forEach((item) => {
        item.nsn_items.forEach((nsn_item) => {
          nsn_item.serial_numbers.forEach((serial_number) => {
            if (
              serial_number.assignment !== null &&
              role_symbols.includes(serial_number.assignment)
            ) {
              // First grab the role object, set that as the key for our map
              const role = role_list.filter(
                (role) => role.role === serial_number.assignment,
              )[0];
              // Get our blank array so we can pushback on it
              if (!boxes.has(role)) {
                boxes.set(role, []);
              }

              boxes.get(role).push({
                mpo_description: item.mpo_description,
                nsn_description: nsn_item.nsn_description,
                serial_number: serial_number.serial_number,
              });
            }
          });
        });
      });

      return boxes;
    }

    function render_boxes(role_list = null) {
      boxes = build_boxes(role_list);

      boxes.forEach((value, key, map) => {
        const individualBox = document.createElement("details");
        individualBox.classList.add("individualBox");

        const header = document.createElement("summary");
        header.classList.add("boxHeader");
        header.insertAdjacentHTML(
          "beforeend",
          `<h3>${key.name} (${key.role})</h3>`,
        );

        const rightGrouping = document.createElement("div");
        rightGrouping.classList.add("rightGrouping");
        rightGrouping.insertAdjacentHTML(
          "beforeend",
          `<svg class="icons" data-slot="icon" aria-hidden="true" fill="none" stroke-width="1.5" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="m19.5 8.25-7.5 7.5-7.5-7.5" stroke-linecap="round" stroke-linejoin="round"></path>
                                            </svg>`,
        );
        header.appendChild(rightGrouping);

        individualBox.appendChild(header);

        value.forEach((assignment) => {
          const lineItem = document.createElement("div");
          lineItem.style.display = "flex";
          lineItem.style.justifyContent = "space-between";

          lineItem.insertAdjacentHTML(
            "beforeend",
            `<span>${
              assignment.mpo_description ? assignment.mpo_description : ""
            }</span>`,
          );
          lineItem.insertAdjacentHTML(
            "beforeend",
            `<span>${assignment.nsn_description}</span>`,
          );
          lineItem.insertAdjacentHTML(
            "beforeend",
            `<span>${assignment.serial_number}</span>`,
          );

          individualBox.appendChild(lineItem);
        });

        document.getElementById("boxesList").appendChild(individualBox);
      });
    }

    // Pre-populate roles/names, this will come from the start screen later
    const roles = [
      { name: "Tony", role: "Z" },
      { name: "Joel", role: "W" },
      { name: "Chuck", role: "B1" },
      { name: "Hayden", role: "B2" },
      { name: "Forrest", role: "C1" },
      { name: "Jordan", role: "C2" },
      { name: "Eli", role: "D1" },
      { name: "Tommy", role: "D2" },
      { name: "Paul", role: "E1" },
      { name: "Rhyan", role: "E2" },
    ];

    roles.forEach((person) => {
      document
        .getElementById("namesList")
        .insertAdjacentHTML(
          "beforeend",
          `<div class="namesAndRoles"><p class="name">${person.name}</p><p class="role">${person.role}</p></div>`,
        );
    });

    const modal = document.getElementById("editTeamModal");
    const openModal = document.getElementById("editTeam");
    const closeModal = document.getElementById("closeModal");

    //openModal.addEventListener("click", () => {
    //modal.showModal();
    //});

    function render_edit_team_list(role_list) {
      roles.forEach((person) => {
        document
          .getElementById("editTeamModal")
          .insertAdjacentHTML(
            "afterbegin",
            `<div class="editNamesList"><input type="text" class="editName" placeholder="${person.name}"</><p class="role">${person.role}</p></div>`,
          );
      });

      closeModal.addEventListener("click", () => {
        modal.close();
      });
    }

    render_edit_team_list(roles);

    // Setup out start screen
    let input = document.getElementById("input");
    let items = [];

    input.addEventListener("change", function () {
      readXlsxFile(input.files[0]).then(function (data) {
        let parsedRows = parseItems(data);
        const itemObjects = [];
        parsedRows.forEach((item_as_rows) => {
          itemObjects.push(new item(item_as_rows));
        });

        items = itemObjects.slice();

        // render_list(document.getElementById("inventoryList"), items);
        toggle_page(
          "main_page",
          document.getElementById("inventoryList"),
          items,
        );
      });
    });
  </script>
</html>
